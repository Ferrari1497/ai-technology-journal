name: Stop All AWS Environments

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨

permissions:
  contents: read

jobs:
  stop-all-environments:
    runs-on: ubuntu-latest
    
    steps:
    - name: Stop all AWS environments
      run: |
        echo "ğŸ›‘ Stopping ALL AWS environments to prevent charges..."
        
        # å…¨S3ãƒã‚±ãƒƒãƒˆã‚’ãƒªã‚¹ãƒˆ
        echo "ğŸ“‹ Listing all S3 buckets..."
        aws s3 ls
        
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒã‚±ãƒƒãƒˆåœæ­¢
        STAGING_BUCKET="${{ secrets.S3_BUCKET_STAGING }}"
        if [ -n "$STAGING_BUCKET" ]; then
          echo "ğŸ›‘ Stopping staging: $STAGING_BUCKET"
          aws s3 rm s3://$STAGING_BUCKET --recursive || true
          aws s3api delete-bucket-website --bucket $STAGING_BUCKET || true
          aws s3api delete-bucket-policy --bucket $STAGING_BUCKET || true
          aws s3api delete-bucket --bucket $STAGING_BUCKET || true
        fi
        
        # æœ¬ç•ªãƒã‚±ãƒƒãƒˆåœæ­¢
        PROD_BUCKET="${{ secrets.S3_BUCKET_PROD }}"
        if [ -n "$PROD_BUCKET" ]; then
          echo "ğŸ›‘ Stopping production: $PROD_BUCKET"
          aws s3 rm s3://$PROD_BUCKET --recursive || true
          aws s3api delete-bucket-website --bucket $PROD_BUCKET || true
          aws s3api delete-bucket-policy --bucket $PROD_BUCKET || true
          aws s3api delete-bucket --bucket $PROD_BUCKET || true
        fi
        
        # CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
        CLOUDFRONT_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}"
        if [ -n "$CLOUDFRONT_ID" ]; then
          echo "â˜ï¸ Disabling CloudFront distribution: $CLOUDFRONT_ID"
          aws cloudfront get-distribution-config --id $CLOUDFRONT_ID --query 'DistributionConfig' > /tmp/dist-config.json || true
          # CloudFrontã®ç„¡åŠ¹åŒ–ã¯è¤‡é›‘ãªãŸã‚ã€æ‰‹å‹•ã§è¡Œã†ã“ã¨ã‚’æ¨å¥¨
          echo "âš ï¸ CloudFront distribution needs manual deletion from AWS Console"
        fi
        
        # æ®‹å­˜ãƒã‚±ãƒƒãƒˆã®ç¢ºèª
        echo "ğŸ“‹ Remaining S3 buckets:"
        aws s3 ls || echo "No buckets remaining"
        
        echo "âœ… All environments stopped!"
        echo "ğŸ’° AWS charges should now be $0.00/month"
        echo "âš ï¸ Please check AWS Console to confirm all resources are deleted"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ap-northeast-1