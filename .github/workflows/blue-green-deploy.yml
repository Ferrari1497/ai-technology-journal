name: Blue-Green Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production

jobs:
  blue-green-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Pre-deploy checks
      run: node scripts/pre-deploy.js
      
    - name: Set environment variables
      run: |
        echo "NEXT_PUBLIC_SITE_URL=https://ai-tech-journal.com" >> $GITHUB_ENV
        echo "NEXT_PUBLIC_ENVIRONMENT=production" >> $GITHUB_ENV
        echo "BLUE_BUCKET=${{ secrets.S3_BUCKET_PROD }}" >> $GITHUB_ENV
        echo "GREEN_BUCKET=${{ secrets.S3_BUCKET_PROD }}-green" >> $GITHUB_ENV
        echo "CLOUDFRONT_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}" >> $GITHUB_ENV
        
    - name: Build and export
      run: |
        npm run build
        npm run export
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1
        
    - name: Deploy to Green environment
      run: |
        echo "ğŸŸ¢ Deploying to Green environment..."
        aws s3 sync out/ s3://$GREEN_BUCKET --delete
        
    - name: Test Green environment
      run: |
        echo "ğŸ§ª Testing Green environment..."
        # Greenç’°å¢ƒã®ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯å°‚ç”¨URLã§ãƒ†ã‚¹ãƒˆï¼‰
        sleep 10
        
    - name: Switch to Green (Blue-Green swap)
      run: |
        echo "ğŸ”„ Switching Blue-Green environments..."
        
        # ç¾åœ¨ã®Blueç’°å¢ƒã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        aws s3 sync s3://$BLUE_BUCKET s3://$BLUE_BUCKET-backup --delete
        
        # Greenç’°å¢ƒã‚’Blueç’°å¢ƒã«ã‚³ãƒ”ãƒ¼
        aws s3 sync s3://$GREEN_BUCKET s3://$BLUE_BUCKET --delete
        
        # CloudFrontã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
        aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
        
    - name: Wait for deployment
      run: sleep 30
      
    - name: Verify production deployment
      run: node scripts/post-deploy.js production
      
    - name: Cleanup on success
      run: |
        echo "ğŸ§¹ Cleaning up Green environment..."
        aws s3 rm s3://$GREEN_BUCKET --recursive
        
    - name: Rollback on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed, rolling back..."
        aws s3 sync s3://$BLUE_BUCKET-backup s3://$BLUE_BUCKET --delete
        aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
        
    - name: Create deployment report
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const success = '${{ job.status }}' === 'success';
          const issueBody = `
          ## Blue-Green ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
          
          **ç’°å¢ƒ**: production
          **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
          **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          **å®Ÿè¡Œè€…**: ${{ github.actor }}
          
          ### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè©³ç´°
          - Blueç’°å¢ƒ: ${{ secrets.S3_BUCKET_PROD }}
          - Greenç’°å¢ƒ: ${{ secrets.S3_BUCKET_PROD }}-green
          - CloudFront: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}
          
          ${success ? 
            '### âœ… æˆåŠŸ\n- Greenç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†\n- ãƒ†ã‚¹ãƒˆé€šé\n- Blue-Greenåˆ‡ã‚Šæ›¿ãˆå®Œäº†\n- æœ¬ç•ªç’°å¢ƒæ¤œè¨¼å®Œäº†' :
            '### âŒ å¤±æ•—\n- è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ\n- èª¿æŸ»ãŒå¿…è¦ã§ã™'
          }
          
          ---
          *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Blue-Green ãƒ‡ãƒ—ãƒ­ã‚¤ ${success ? 'æˆåŠŸ' : 'å¤±æ•—'}: ${new Date().toISOString().split('T')[0]}`,
            body: issueBody,
            labels: ['deployment', 'blue-green', success ? 'success' : 'failure']
          });
          
    - name: Deployment summary
      run: |
        echo "ğŸ¯ Blue-Green Deployment completed"
        echo "Status: ${{ job.status }}"
        echo "Environment: production"
        echo "URL: https://ai-tech-journal.com"