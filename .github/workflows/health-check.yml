name: Health Check

on:
  # schedule:
  #   # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ - DISABLED
  #   - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: 'both'
        type: choice
        options:
        - both
        - production
        - staging

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run health check
      id: health-check
      run: node scripts/health-check.js
      continue-on-error: true
      
    - name: Upload health report
      uses: actions/upload-artifact@v4
      with:
        name: health-check-report-${{ github.run_number }}
        path: health-check-report.json
        retention-days: 7
        
    - name: Check health status
      run: |
        if [ -f health-check-report.json ]; then
          OVERALL_STATUS=$(node -e "
            const report = require('./health-check-report.json');
            console.log(report.overall);
          ")
          
          if [ "$OVERALL_STATUS" = "false" ]; then
            echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—"
            exit 1
          else
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
          fi
        else
          echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let reportData = {};
          try {
            reportData = JSON.parse(fs.readFileSync('health-check-report.json', 'utf8'));
          } catch (error) {
            reportData = { error: 'ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ' };
          }
          
          const issueBody = `
          ## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•— ğŸš¨
          
          **å®Ÿè¡Œæ™‚åˆ»**: ${reportData.timestamp || new Date().toISOString()}
          
          ### URL ãƒã‚§ãƒƒã‚¯çµæœ
          ${Object.entries(reportData.urls || {}).map(([env, result]) => 
            `- **${env}**: ${result.success ? 'âœ…' : 'âŒ'} ${result.status || result.error}`
          ).join('\n')}
          
          ### ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ  ãƒã‚§ãƒƒã‚¯çµæœ
          ${(reportData.filesystem || []).filter(check => !check.exists).map(check => 
            `- âŒ ${check.type}: ${check.path}`
          ).join('\n') || 'å•é¡Œãªã—'}
          
          ### è¨˜äº‹æ•°
          ${Object.entries(reportData.posts || {}).map(([lang, data]) => 
            `- **${lang}**: ${data.count}ä»¶`
          ).join('\n')}
          
          ### å¯¾å¿œãŒå¿…è¦ãªé …ç›®
          1. å¤±æ•—ã—ãŸURLã®ç¢ºèªã¨ä¿®å¾©
          2. ä¸è¶³ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¾©æ—§
          3. è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèª
          
          ---
          *ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—: ${new Date().toISOString().split('T')[0]}`,
            body: issueBody,
            labels: ['health-check', 'automated', 'urgent']
          });
          
    - name: Notify success
      if: success()
      run: |
        echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº† - ã™ã¹ã¦æ­£å¸¸ã§ã™"