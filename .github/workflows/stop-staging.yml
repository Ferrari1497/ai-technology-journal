name: Stop Staging Environment

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨

permissions:
  contents: read

jobs:
  stop-staging:
    runs-on: ubuntu-latest
    
    steps:
    - name: Stop S3 staging environment
      run: |
        echo "ğŸ›‘ Stopping S3 staging environment to prevent charges..."
        
        BUCKET_NAME="${{ secrets.S3_BUCKET_STAGING }}"
        
        # 1. ãƒã‚±ãƒƒãƒˆå†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        echo "ğŸ—‘ï¸ Deleting all files in bucket..."
        aws s3 rm s3://$BUCKET_NAME --recursive
        
        # 2. ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆè¨­å®šã‚’å‰Šé™¤
        echo "ğŸŒ Removing website configuration..."
        aws s3api delete-bucket-website --bucket $BUCKET_NAME || echo "Website config already removed"
        
        # 3. ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã‚’å‰Šé™¤
        echo "ğŸ“ Removing bucket policy..."
        aws s3api delete-bucket-policy --bucket $BUCKET_NAME || echo "Bucket policy already removed"
        
        # 4. ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–
        echo "ğŸ”’ Enabling public access block..."
        aws s3api put-public-access-block \
          --bucket $BUCKET_NAME \
          --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
        
        # 5. ãƒã‚±ãƒƒãƒˆè‡ªä½“ã‚’å‰Šé™¤
        echo "ğŸ—‚ï¸ Deleting bucket..."
        aws s3api delete-bucket --bucket $BUCKET_NAME
        
        echo "âœ… S3 staging environment completely stopped!"
        echo "ğŸ’° No more charges will occur from this environment"
        echo "ğŸŒ URL will no longer be accessible: http://$BUCKET_NAME.s3-website-ap-northeast-1.amazonaws.com"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ap-northeast-1