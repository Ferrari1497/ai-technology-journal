name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
        - staging
        - production
      commit_sha:
        description: 'Commit SHA to rollback to (optional)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.commit_sha || github.sha }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Set environment variables
      run: |
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "NEXT_PUBLIC_SITE_URL=https://ai-tech-journal.com" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=production" >> $GITHUB_ENV
          echo "TARGET_BUCKET=${{ secrets.S3_BUCKET_PROD }}" >> $GITHUB_ENV
          echo "CLOUDFRONT_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }}" >> $GITHUB_ENV
        else
          echo "NEXT_PUBLIC_SITE_URL=https://staging.ai-tech-journal.com" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=staging" >> $GITHUB_ENV
          echo "TARGET_BUCKET=${{ secrets.S3_BUCKET_STAGING }}" >> $GITHUB_ENV
          echo "CLOUDFRONT_ID=${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_STAGING }}" >> $GITHUB_ENV
        fi
        
    - name: Build and export
      run: |
        npm run build
        npm run export
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1
        
    - name: Rollback deployment
      run: |
        echo "ğŸ”„ Rolling back to commit: ${{ github.event.inputs.commit_sha || github.sha }}"
        aws s3 sync out/ s3://$TARGET_BUCKET --delete
        aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
        
    - name: Wait for rollback
      run: sleep 30
      
    - name: Verify rollback
      run: node scripts/post-deploy.js ${{ github.event.inputs.environment }}
      
    - name: Create rollback issue
      uses: actions/github-script@v7
      with:
        script: |
          const issueBody = `
          ## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ ğŸ”„
          
          **ç’°å¢ƒ**: ${{ github.event.inputs.environment }}
          **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆ**: ${{ github.event.inputs.commit_sha || github.sha }}
          **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
          **å®Ÿè¡Œè€…**: ${{ github.actor }}
          
          ### è©³ç´°
          - URL: ${{ env.NEXT_PUBLIC_SITE_URL }}
          - å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
          
          ### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          1. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯åŸå› ã®èª¿æŸ»
          2. å•é¡Œã®ä¿®æ­£
          3. å†ãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™
          
          ---
          *ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ: ${{ github.event.inputs.environment }} - ${new Date().toISOString().split('T')[0]}`,
            body: issueBody,
            labels: ['rollback', 'automated', 'urgent']
          });
          
    - name: Rollback summary
      run: |
        echo "ğŸ”„ Rollback completed"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Commit: ${{ github.event.inputs.commit_sha || github.sha }}"
        echo "URL: ${{ env.NEXT_PUBLIC_SITE_URL }}"